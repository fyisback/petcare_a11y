const express = require('express');
const path = require('path');

// 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î —Ç–∞–±–ª–∏—Ü—ñ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ)
const db = require('./services/db'); 

// 2. –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ (Cron Job)
// –¶–µ –∑–∞–ø—É—Å–∫–∞—î —Ç–∞–π–º–µ—Ä, —è–∫–∏–π —â–æ–¥–Ω—è –æ 12:00 –∑–∞ –ö–∏—î–≤–æ–º –æ–Ω–æ–≤–ª—é—î –¥–∞–Ω—ñ
require('./services/scheduler'); 

const app = express();
const PORT = process.env.PORT || 3000;

// --- Middleware (–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–∞) ---
// –î–æ–∑–≤–æ–ª—è—î —Å–µ—Ä–≤–µ—Ä—É —Ä–æ–∑—É–º—ñ—Ç–∏ –¥–∞–Ω—ñ, –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º–∏ (POST –∑–∞–ø–∏—Ç–∏)
app.use(express.urlencoded({ extended: true })); 
app.use(express.json());

// –í–∫–∞–∑—É—î–º–æ –ø–∞–ø–∫—É –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ (CSS, –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ —Å–∫—Ä–∏–ø—Ç–∏)
app.use(express.static(path.join(__dirname, 'public'))); 

// --- View Engine (–®–∞–±–ª–æ–Ω—ñ–∑–∞—Ç–æ—Ä) ---
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// --- –ú–∞—Ä—à—Ä—É—Ç–∏ (Routes) ---

// 1. –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ (–î–∞—à–±–æ—Ä–¥ + –ï–∫—Å–ø–æ—Ä—Ç —É CSV)
app.use('/', require('./routes/dashboard'));

// 2. –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å (–î–æ–¥–∞–≤–∞–Ω–Ω—è/–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è/–í–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ–µ–∫—Ç—ñ–≤)
app.use('/admin', require('./routes/admin'));

// 3. –¢–∏–∂–Ω–µ–≤—ñ –∑–≤—ñ—Ç–∏ (—è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è)
app.use('/weekly', require('./routes/weekly'));

// 4. üî• –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç—É (–Ü—Å—Ç–æ—Ä—ñ—è + –ó–∞–¥–∞—á—ñ Action Items)
app.use('/project', require('./routes/project'));

// --- –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏ 404 (–°—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞) ---
app.use((req, res) => {
    // –†–µ–Ω–¥–µ—Ä–∏–º–æ –∫—Ä–∞—Å–∏–≤—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø–æ–º–∏–ª–∫–∏, —è–∫—â–æ –≤–æ–Ω–∞ —î
    res.status(404).render('404');
});

// --- –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ ---
app.listen(PORT, () => {
    console.log(`-----------------------------------------------`);
    console.log(`‚úÖ Server is running on port ${PORT}`);
    console.log(`üëâ Local:   http://localhost:${PORT}`);
    console.log(`‚è∞ Scheduler is active (12:00 Kyiv Time)`);
    console.log(`-----------------------------------------------`);
});