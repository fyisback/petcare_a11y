<%- include('partials/header') %>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><%= pageTitle %></h1>
        
        <form action="/refresh" method="POST" style="display: inline;">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Refresh All Data
            </button>
        </form>
    </div>

    <% if (error === 'RefreshFailed') { %>
        <div class="alert alert-danger">
            Failed to refresh data. Please check logs.
        </div>
    <% } %>

    <% if (averageScores && averageScores.length > 0) { %>
        <div class="row mb-4">
            <% averageScores.forEach(item => { %>
                <div class="col-md-3">
                    <div class="card text-white bg-info mb-3">
                        <div class="card-header"><%= item.category %></div>
                        <div class="card-body">
                            <h5 class="card-title">Avg Score: <%= item.average %>%</h5>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
    <% } %>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Active Projects</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="projects-table" class="table table-bordered table-striped table-hover" width="100%" cellspacing="0">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 25%;">Project</th>
                            <th style="text-align: center;">Score</th>
                            
                            <th style="text-align: center;" title="Total Issues">Total</th>
                            <th style="text-align: center; color: #ffadad;" title="Critical Issues">Crit</th>
                            <th style="text-align: center; color: #ffd6a5;" title="Serious Issues">Ser</th>
                            <th style="text-align: center;" title="Moderate Issues">Mod</th>
                            
                            <th style="font-size: 0.9em;">Scan Date</th>
                            <th style="text-align: center;">Report</th>
                            <th>Category</th>
                            <th style="text-align: center;">History</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (activeProjectsData.length > 0) { %>
                            <% activeProjectsData.forEach(project => { %>
                                <%
                                    let cellStyle = '';
                                    if (project.success && typeof project.scoreValue === 'number') {
                                        if (project.scoreValue < 80) cellStyle = 'background-color: #dc3545; color: white;';
                                        else if (project.scoreValue < 90) cellStyle = 'background-color: #ffc107; color: black;';
                                        else cellStyle = 'background-color: #28a745; color: white;';
                                    }
                                %>
                                <tr>
                                    <td>
                                        <strong><%= project.custom_title || project.project_url %></strong>
                                        <br>
                                        <a href="<%= project.project_url %>" target="_blank" class="small text-primary">
                                            <i class="fas fa-external-link-alt"></i> Open Site
                                        </a>
                                    </td>

                                    <td style="<%= cellStyle %>; text-align: center; font-weight: bold; vertical-align: middle;">
                                        <%= project.score %>
                                    </td>

                                    <td style="text-align: center; font-weight: bold; vertical-align: middle;">
                                        <%= project.total %>
                                    </td>

                                    <td style="text-align: center; color: #dc3545; font-weight: bold; vertical-align: middle; background-color: #fff3f3;">
                                        <%= project.critical %>
                                    </td>

                                    <td style="text-align: center; color: #fd7e14; font-weight: bold; vertical-align: middle;">
                                        <%= project.serious %>
                                    </td>

                                    <td style="text-align: center; vertical-align: middle;">
                                        <%= project.moderate %>
                                    </td>

                                    <td class="small" style="vertical-align: middle;">
                                        <%= project.scanDate %>
                                    </td>

                                    <td style="text-align: center; vertical-align: middle;">
                                        <%- project.reportButton %>
                                    </td>

                                    <td style="vertical-align: middle;"><%= project.category %></td>

                                    <td style="text-align: center; vertical-align: middle;">
                                        <a href="/project/<%= project.id %>/score-history" class="btn btn-sm btn-info">
                                            Details
                                        </a>
                                    </td>

                                    <td style="vertical-align: middle;"><span class="badge badge-secondary"><%= project.status %></span></td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="11" class="text-center">No active projects found.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <% if (onHoldProjects && onHoldProjects.length > 0) { %>
        <h3 class="mt-5">On Hold Projects</h3>