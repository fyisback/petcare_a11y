<%- include('partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Стилі Purina */
    :root {
        --purina-red: #E2231A;
        --purina-dark: #1C1C1C;
        --purina-grey: #F4F4F4;
    }

    body {
        background-color: var(--purina-grey);
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    /* Картка Purina */
    .card-purina {
        border: none;
        border-top: 4px solid var(--purina-red);
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }

    .card-header {
        background-color: white;
        color: var(--purina-dark);
        font-weight: 700;
        text-transform: uppercase;
        border-bottom: 1px solid #eee;
    }

    /* Кнопка Назад */
    .btn-back {
        background-color: var(--purina-dark);
        color: white;
        border-radius: 0;
        padding: 8px 20px;
        font-weight: bold;
        transition: 0.2s;
    }
    .btn-back:hover {
        background-color: #333;
        color: white;
        text-decoration: none;
    }

    /* Стилізація таблиці */
    .table-history thead th {
        background-color: var(--purina-dark);
        color: white;
        border: none;
        border-bottom: 3px solid var(--purina-red);
        text-align: center;
        vertical-align: middle;
    }
    
    .table-history td {
        vertical-align: middle;
        text-align: center;
    }

    /* Кольори для тексту */
    .text-critical { color: #D32F2F; font-weight: 800; }
    .text-serious { color: #E65100; font-weight: 700; }
    .text-moderate { color: #F57F17; font-weight: 600; }
    .text-dim { color: #ccc; }
</style>

<div class="container mt-4 mb-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="text-muted mb-1 text-uppercase" style="font-size: 0.9rem;">Project History Analysis</h5>
            <h2 style="font-weight: 800; color: var(--purina-dark); margin: 0;">
                <%= project.custom_title || 'Project Details' %>
            </h2>
            <a href="<%= project.project_url %>" target="_blank" style="color: var(--purina-red); text-decoration: underline;">
                <%= project.project_url %> <i class="fas fa-external-link-alt small"></i>
            </a>
        </div>
        <a href="/" class="btn btn-back shadow-sm">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <div class="card card-purina">
        <div class="card-header">
            Performance Trend (Score vs Critical Issues)
        </div>
        <div class="card-body">
            <canvas id="historyChart" style="max-height: 350px; width: 100%;"></canvas>
        </div>
    </div>

    <div class="card card-purina">
        <div class="card-header">
            Detailed Scan Logs
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0 table-history">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding-left: 20px;">Scan Date</th>
                            <th>Score</th>
                            <th>Total Issues</th>
                            <th style="background-color: #fff0f0; color: #D32F2F;">Critical</th>
                            <th>Serious</th>
                            <th>Moderate</th>
                            <th>Minor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (history && history.length > 0) { %>
                            <% history.forEach(scan => { %>
                                <% 
                                    let scoreColor = '#28a745';
                                    if (scan.score < 80) scoreColor = '#D32F2F';
                                    else if (scan.score < 90) scoreColor = '#FBC02D';
                                %>
                                <tr>
                                    <td style="text-align: left; padding-left: 20px;">
                                        <strong><%= scan.scan_date %></strong><br>
                                        <small class="text-muted">Checked at: <%= new Date(scan.checked_at).toLocaleTimeString() %></small>
                                    </td>

                                    <td>
                                        <span class="badge" style="background-color: <%= scoreColor %>; color: white; font-size: 1em; width: 60px; padding: 8px;">
                                            <%= scan.score %>%
                                        </span>
                                    </td>

                                    <td style="font-weight: bold;"><%= scan.total_issues || 0 %></td>
                                    
                                    <td style="background-color: #fff5f5;">
                                        <% if (scan.critical_issues > 0) { %>
                                            <span class="text-critical"><%= scan.critical_issues %></span>
                                        <% } else { %>
                                            <span class="text-dim">0</span>
                                        <% } %>
                                    </td>
                                    
                                    <td>
                                        <% if (scan.serious_issues > 0) { %>
                                            <span class="text-serious"><%= scan.serious_issues %></span>
                                        <% } else { %>
                                            <span class="text-dim">0</span>
                                        <% } %>
                                    </td>
                                    
                                    <td>
                                        <% if (scan.moderate_issues > 0) { %>
                                            <span class="text-moderate"><%= scan.moderate_issues %></span>
                                        <% } else { %>
                                            <span class="text-dim">0</span>
                                        <% } %>
                                    </td>

                                    <td class="text-muted">
                                        <%= scan.minor_issues || 0 %>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <h4 class="text-muted">No scan history available yet.</h4>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Отримуємо дані з EJS
    const rawData = <%- JSON.stringify(history) %>;
    // Реверсуємо, щоб графік йшов зліва направо (від старих до нових)
    const chartData = [...rawData].reverse();

    const labels = chartData.map(h => h.scan_date);
    const scores = chartData.map(h => h.score);
    // Перетворюємо стрічку "1.6K" або "283" в число, якщо треба, але в нас вже нормалізовано в базі
    const criticals = chartData.map(h => {
        let val = h.critical_issues || 0;
        return parseInt(val);
    });

    const ctx = document.getElementById('historyChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Accessibility Score (%)',
                    data: scores,
                    borderColor: '#28a745', // Green
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    yAxisID: 'y',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4
                },
                {
                    label: 'Critical Issues',
                    data: criticals,
                    borderColor: '#E2231A', // Purina Red
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    yAxisID: 'y1',
                    tension: 0.1,
                    pointStyle: 'rectRot',
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: { 
                    backgroundColor: 'rgba(28, 28, 28, 0.9)',
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    min: 0,
                    max: 100,
                    title: { display: true, text: 'Score (%)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Critical Issues Count' },
                    grid: { drawOnChartArea: false },
                    beginAtZero: true
                }
            }
        }
    });
</script>

<%- include('partials/footer') %>